<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="JiangChunbo&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      InnoDB æ—¥å¿— | ğŸ¥«ğŸ
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="ğŸ¥«ğŸ" type="application/atom+xml">
</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>ğŸ¥«ğŸ</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/categories/" class="item-link">Categories</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/categories/" class="menu-link">Categories</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>InnoDB æ—¥å¿—</h2>
  <p class="post-date">2022-07-11</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a target="_blank" rel="noopener" href="http://blog.itpub.net/7728585/viewspace-2284045/">è§£æ roll_pointer</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/427911093">åº–ä¸è§£ç‰› </a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/453169285">InnoDBä¹‹UNDO LOGä»‹ç»</a></p>
<h1 id="Undo-Logs"><a href="#Undo-Logs" class="headerlink" title="Undo Logs"></a>Undo Logs</h1><p>Undo Log æ˜¯ä¸€æ¡æˆ–è€…å¤šæ¡ Undo Log Record çš„é›†åˆï¼Œæ¯ä¸€æ¡ Undo Log Record éƒ½ä¸ä¸€ä¸ªè¯»å†™äº‹åŠ¡ç›¸å…³ã€‚æ¯æ¡ Undo Log è®°å½•åŒ…å«äº†æœ‰å…³å¦‚ä½•æ’¤é”€äº‹åŠ¡æœ€æ–°æ›´æ”¹çš„ä¿¡æ¯<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html">[?]</a>ã€‚</p>
<h2 id="1-Undo-Tablespaces"><a href="#1-Undo-Tablespaces" class="headerlink" title="1. Undo Tablespaces"></a>1. Undo Tablespaces</h2><p>Undo Tablesapces åŒ…å«è®¸å¤š Undo Logã€‚</p>
<blockquote>
<p>MySQL æœ€å¤šæ”¯æŒ 127 ä¸ª Undo Tablespaceã€‚é»˜è®¤ä¸º 2 ä¸ªã€‚</p>
</blockquote>
<p>InnoDB æ˜¯ä¸€ä¸ªå¤šç‰ˆæœ¬çš„å­˜å‚¨å¼•æ“ã€‚å®ƒå¯ä»¥ä¿ç•™æœ‰å…³æ›´æ”¹è¡Œçš„æ—§ç‰ˆæœ¬çš„ä¿¡æ¯ï¼Œä»¥æ”¯æŒäº‹åŠ¡åŠŸèƒ½ï¼Œä¾‹å¦‚å¹¶å‘å’Œå›æ»šã€‚æ­¤ä¿¡æ¯ä»¥ä¸€ä¸ªç§°ä¸ºå›æ»šæ®µçš„æ•°æ®ç»“æ„ï¼Œå­˜å‚¨äº undo è¡¨ç©ºé—´ã€‚å›æ»šæ®µé©»ç•™åœ¨ undo è¡¨ç©ºé—´å’Œå…¨å±€ä¸´æ—¶è¡¨ç©ºé—´ä¸­<a href="s">[1]</a>ã€‚</p>
<img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/undo-tablespace.png">


<h2 id="2-Rollback-Segment"><a href="#2-Rollback-Segment" class="headerlink" title="2. Rollback Segment"></a>2. Rollback Segment</h2><p>InnoDB åœ¨ Undo Tablespace ä¸­ä½¿ç”¨ Rollback Segment æ¥ç»„ç»‡ Undo Logï¼Œæœ€å¤šæ”¯æŒ 128 ä¸ª Rollback Segmentã€‚</p>
<p>å…¶ä¸­ç¬¬ 0 å·ã€33-127å·é’ˆå¯¹æ™®é€šè¡¨è®¾è®¡ï¼Œ1-32 å·é’ˆå¯¹ä¸´æ—¶è¡¨è®¾è®¡ã€‚</p>
<blockquote>
<p>ä¸€ä¸ªäº‹åŠ¡å¯èƒ½å³æ“ä½œäº†ä¸´æ—¶è¡¨ï¼Œä¹Ÿæ“ä½œäº†ç‰©ç†è¡¨ï¼Œå› æ­¤ï¼Œä¸€ä¸ªäº‹åŠ¡æ˜¯å¯ä»¥ä½¿ç”¨å¤šä¸ª Rollback Segmentã€‚</p>
</blockquote>
<h2 id="3-Rollback-Segment-Array-Header"><a href="#3-Rollback-Segment-Array-Header" class="headerlink" title="3. Rollback Segment Array Header"></a>3. Rollback Segment Array Header</h2><p>Undo Tablespace æ–‡ä»¶ä¸­çš„ç¬¬ 3 ä¸ª Page å›ºå®šä½œä¸ºè¿™ 128 ä¸ª Rollback Segment çš„ç›®å½•ï¼Œå³ Rollback Segment Array Header</p>
<h2 id="4-Rollback-Segment-Header"><a href="#4-Rollback-Segment-Header" class="headerlink" title="4. Rollback Segment Header"></a>4. Rollback Segment Header</h2><p>é€šè¿‡ Rollback Segment Header æ¥ç®¡ç† Rollback Segmentï¼ŒRollback Segment Header é€šå¸¸åœ¨ Rollback Segment ç¬¬ 1 é¡µã€‚</p>
<img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/rollback_segment_header.png" width="300">

<table>
<thead>
<tr>
<th><div style="width:200px">å­—æ®µ</div></th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Max Size</td>
<td>å‚æ•°å TRX_RSEG_MAX_SIZEï¼Œ å›æ»šæ®µå¯ç”¨çš„æœ€å¤§ Page æ•°</td>
</tr>
<tr>
<td>History Size</td>
<td>å‚æ•°å TRX_RSEG_HISTORY_SIZEï¼ŒHistory List åŒ…å«çš„ Page æ•°</td>
</tr>
<tr>
<td>History List Base Node</td>
<td>å‚æ•°å TRX_RSEG_HISTORY</td>
</tr>
</tbody></table>
<p>History List æŠŠæ‰€æœ‰å·²ç»æäº¤ï¼Œä½†è¿˜æ²¡æœ‰è¢« purge çš„äº‹åŠ¡çš„ Undo Log è¿æ¥èµ·æ¥ï¼Œpurge çº¿ç¨‹å¯ä»¥é€šè¿‡æ­¤ List å¯¹å·²ç»æ²¡æœ‰äº‹åŠ¡ä½¿ç”¨çš„ Undo Log è¿›è¡Œ purgeã€‚</p>
<p>æ¯ä¸ªäº‹åŠ¡åœ¨éœ€è¦è®°å½• Undo Log æ—¶éƒ½ä¼šç”³è¯· 1 ä¸ªæˆ–è€… 2 ä¸ª Slotï¼ˆINSERT å’Œ UPDATE åˆ†å¼€ï¼‰ï¼ŒåŒæ—¶æŠŠäº‹åŠ¡çš„ç¬¬ä¸€ä¸ª Undo Page æ”¾å…¥å¯¹åº” Slot ä¸­</p>
<h3 id="5-Undo-Page"><a href="#5-Undo-Page" class="headerlink" title="5. Undo Page"></a>5. Undo Page</h3><p>Undo Page ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šHeader Page å’Œ Normal Pageã€‚</p>
<img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/undo-page.png">


<p>Undo Header Page æ˜¯äº‹åŠ¡éœ€è¦å†™ Undo Log æ—¶ç”³è¯·çš„ç¬¬ä¸€ä¸ª Undo Page</p>
<p>Undo Header Page æ˜¯å½“æ´»è·ƒäº‹åŠ¡äº§ç”Ÿçš„ Undo Record è¶…è¿‡ Undo Header Page å®¹é‡åï¼Œå•ç‹¬åˆ†é…çš„ Undo Page</p>
<h3 id="6-Undo-Page-Header"><a href="#6-Undo-Page-Header" class="headerlink" title="6. Undo Page Header"></a>6. Undo Page Header</h3><img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/undo-page-header.png" width="400">

<table>
<thead>
<tr>
<th><div style="width:200px">å­—æ®µ</div></th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Undo Page Type</td>
<td>TRX_UNDO_PAGE_TYPEï¼Œä½¿ç”¨è¯¥é¡µäº‹åŠ¡çš„ç±»å‹<br>å¯é€‰å€¼: TRX_UNDO_INSERTã€TRX_UNDO_UPDATE</td>
</tr>
<tr>
<td>Latest Log Record Offset</td>
<td>æœ€æ–°äº‹åŠ¡å¼€å§‹è®°å½• Undo Log çš„ä½ç½®</td>
</tr>
<tr>
<td>Free Space Offset</td>
<td>é¡µå†…ç©ºé—²ç©ºé—´èµ·å§‹åœ°å€ï¼Œåœ¨æ­¤ä¹‹åå¯è®°å½• Undo Log</td>
</tr>
<tr>
<td>Undo Page List Node</td>
<td>undo page listèŠ‚ç‚¹ï¼Œå¯ä»¥æŠŠåŒä¸€ä¸ªäº‹åŠ¡æ‰€ç”¨åˆ°çš„æ‰€æœ‰undo pageåŒå‘ä¸²è”èµ·æ¥</td>
</tr>
</tbody></table>
<h3 id="6-Undo-Segment"><a href="#6-Undo-Segment" class="headerlink" title="6. Undo Segment"></a>6. Undo Segment</h3><p>InnoDB ä¸­çš„ Undo Tablespace ä¸­å‡†å¤‡äº†å¤§é‡çš„ Undo Segment æ§½ä½ï¼Œé»˜è®¤æŒ‰ç…§ 1024 ä¸€ç»„åˆ’åˆ†ä¸º Rollback Segmentã€‚</p>
<blockquote>
<p>æ¯ä¸ª Undo Tablespace æœ€å¤šä¼šåŒ…å«128 ä¸ª Rollback Segmentã€‚1 ä¸ª Undo Slot å¯¹åº” 1 ä¸ª Undo Segment</p>
</blockquote>
<p>æ¯ä¸ªå†™äº‹åŠ¡å¼€å§‹å†™æ“ä½œä¹‹å‰éƒ½éœ€è¦æŒæœ‰ä¸€ä¸ª Undo Segmentã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ¯ä¸ª Undo Segment éƒ½æ˜¯è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å çš„ã€‚</p>
<p>å¯¹äºè¾ƒå¤§çš„ Undo Log éšç€ä¸æ–­åœ°å†™å…¥ï¼ŒæŒ‰éœ€åˆ†é…è¶³å¤Ÿå¤šçš„ Undo Page åˆ†æ•£æ‰¿è½½ã€‚</p>
<p>æ¯ä¸ª Undo Segment  è‡³å°‘æŒæœ‰ 1 ä¸ª Undo Pageï¼Œæ¯ä¸ª Undo Page ä¼šåœ¨å¼€å¤´ 38 - 56 å­—èŠ‚è®°å½• Undo Page Headerã€‚</p>
<blockquote>
<p>Rollback Segment ä¸­ Undo Slot å…·ä½“çš„æ•°å€¼æ˜¯ $\frac {Page Size}{16}$ï¼Œè§<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html">15.6.6 Undo Logs</a>ã€‚å› ä¸ºé»˜è®¤ Page Size &#x3D; 16 KBï¼Œå› æ­¤é»˜è®¤ä»¥ 1024 ä¸€ç»„åˆ’åˆ†ä¸ºä¸€ä¸ª Rollback Segmentã€‚</p>
</blockquote>
<h3 id="7-Undo-Segment-Header"><a href="#7-Undo-Segment-Header" class="headerlink" title="7. Undo Segment Header"></a>7. Undo Segment Header</h3><p>Undo Segment ä¸­çš„ç¬¬ 1 ä¸ª Undo Page è¿˜ä¼šåœ¨ 56~86 å­—èŠ‚è®°å½• Undo Segment Headerã€‚</p>
<img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/undo-segment-header.png" style="width: 400px">

<table>
<thead>
<tr>
<th><div style="width:200px">å­—æ®µ</div></th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>State</td>
<td>TRX_UNDO_STATEï¼ŒUndo Segment çš„çŠ¶æ€</td>
</tr>
<tr>
<td>Last Log Offset</td>
<td>TRX_UNDO_LAST_LOGï¼Œå½“å‰é¡µæœ€åä¸€ä¸ª Undo Log Header çš„ä½ç½®</td>
</tr>
<tr>
<td>Undo Segment FSEG Entry</td>
<td>TRX_UNDO_FSEG_HEADERï¼Œsegmentå¯¹åº”çš„inodeçš„ï¼ˆspace_idï¼Œpage_noï¼Œoffsetç­‰ï¼‰</td>
</tr>
<tr>
<td>Undo Segment Page List Base Node</td>
<td>TRX_UNDO_PAGE_LIST,undo page listçš„Base Nodeï¼Œå¯¹äºåŒä¸€ä¸ªäº‹åŠ¡ä¸‹çš„undo header pageå’Œundo normal pageæ„æˆåŒå‘é“¾è¡¨</td>
</tr>
</tbody></table>
<p>TRX_UNDO_PAGE_LISTï¼šå¯¹äºä¸€èˆ¬äº‹åŠ¡æ¥è¯´ï¼Œä¸ä¼šå‡ºç°ä¸€é¡µå†™ä¸ä¸‹çš„æƒ…å†µï¼Œæ‰€ä»¥ï¼Œå¯¹äºå¤§å¤šæ•°äº‹åŠ¡è¯¥é“¾è¡¨é•¿åº¦æ˜¯ 1ã€‚</p>
<p>åœ¨äº‹åŠ¡ç»“æŸ (commit &#x2F; rollback) çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡æ£€æŸ¥ä¸€äº›æ¡ä»¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trx_undo_set_state_at_finish()</span></span><br><span class="line"><span class="keyword">if</span> (undo-&gt;size == <span class="number">1</span> &amp;&amp; mach_read_from_2(page_hdr + TRX_UNDO_PAGE_FREE) &lt; </span><br><span class="line">TRX_UNDO_PAGE_REUSE_LIMIT) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå ç”¨ Page == 1ï¼Œè€Œä¸”æœ¬é¡µä½¿ç”¨ç©ºé—´åç§»é‡å°äº 3 / 4</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆï¼Œæ ‡è®°ä¸º TRX_UNDO_CACHED</span></span><br><span class="line">    state = TRX_UNDO_CACHED;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (undo-&gt;type == TRX_UNDO_INSERT) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç±»å‹ä¸º INSERT</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆï¼Œæ ‡è®°ä¸º TRX_UNDO_TO_FREE</span></span><br><span class="line">    state = TRX_UNDO_TO_FREE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æœ€åå°±æ˜¯ç±»å‹ä¸º UPDATE è€Œä¸”å ç”¨ç©ºé—´è¾ƒå¤š</span></span><br><span class="line">    state = TRX_UNDO_TO_PURGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ ‡è®°ä¸º <code>TRX_UNDO_CACHED</code> çš„ Undo Segment ä¼šåœ¨ <code>trx_undo_insert_cleanup</code> &#x2F; <code>trx_undo_update_cleanup</code> ä¸­æ·»åŠ åˆ° insert cached list &#x2F; update cached list å¤´éƒ¨ã€‚</p>
<p>å¯¹äº INSERT ç±»å‹çš„æ¸…ç†åœ¨ <code>trx_commit_in_memory()</code> ä¼šç›´æ¥é‡Šæ”¾æ‰æ ‡è®°ä¸º <code>TRX_UNDO_TO_FREE</code> çš„ Undo Segmentã€‚</p>
<p>UPDATE ç±»å‹çš„ Undo Segment ä¼šç­‰å¾… Purge å®Œæ¯•å›æ”¶ã€‚</p>
<h3 id="8-Undo-Log-Header"><a href="#8-Undo-Log-Header" class="headerlink" title="8. Undo Log Header"></a>8. Undo Log Header</h3><p>æ¯ä¸ªå†™äº‹åŠ¡ä¼šä¿®æ”¹ä¸€äº›æ•°æ®è®°å½•ï¼Œå¯¹åº”äº§ç”Ÿä¸€äº› Undo Log Recordã€‚è¿™äº› Undo Log Record è¿æ¥åœ¨ä¸€èµ·å½¢æˆè¯¥äº‹åŠ¡çš„ Undo Logã€‚è¿™äº› Undo Log Record å¼€å¤´å­˜åœ¨ä¸€ä¸ª Undo Log Header è®°å½•ä¸€äº›ä¿¡æ¯ã€‚</p>
<img src="https://cannedbread-1302516612.cos.ap-shanghai.myqcloud.com/undo_log_header.png" width="300">


<table>
<thead>
<tr>
<th align="left">å­—æ®µ</th>
<th align="left">å ç”¨</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Transaction ID</td>
<td align="left">8</td>
<td align="left">äº‹åŠ¡ ID</td>
</tr>
<tr>
<td align="left">Delete Mark</td>
<td align="left">2</td>
<td align="left">è¡¨ç¤ºè¯¥ Undo Log æ˜¯å¦å­˜åœ¨ TRX_UNDO_DEL_MARK_REC ç±»å‹çš„ Undo Log Recordï¼Œé¿å… Purge æ—¶ä¸å¿…è¦çš„æ‰«æ</td>
</tr>
<tr>
<td align="left">Log Start Offset</td>
<td align="left">2</td>
<td align="left">è®°å½• Undo Log Header çš„ç»“æŸä½ç½®ï¼Œä¾¿äºä¹‹å Header å¢åŠ å†…å®¹æ—¶çš„å…¼å®¹</td>
</tr>
<tr>
<td align="left">Next Undo Log</td>
<td align="left">2</td>
<td align="left">åä¸€ä¸ª Undo Log</td>
</tr>
<tr>
<td align="left">Prev Undo</td>
<td align="left">2</td>
<td align="left">å‰ä¸€ä¸ª Undo Log</td>
</tr>
</tbody></table>
<h3 id="8-Undo-Log-Record-ç»“æ„"><a href="#8-Undo-Log-Record-ç»“æ„" class="headerlink" title="8. Undo Log Record ç»“æ„"></a>8. Undo Log Record ç»“æ„</h3><p>ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>insert undo log record</li>
<li>update undo log record<br>å…¶ä¸­ï¼Œupdate undo log record è¿˜æœ‰å…¶ä»–æ›´å¤šçš„ç±»åˆ«</li>
</ul>
<h4 id="8-1-Insert-Undo-Log-Record"><a href="#8-1-Insert-Undo-Log-Record" class="headerlink" title="8.1. Insert Undo Log Record"></a>8.1. Insert Undo Log Record</h4><p>TRX_UNDO_INSERT_REC</p>
<table>
<thead>
<tr>
<th align="left">TRX_UNDO_INSERT_REC</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">next (2)</td>
<td align="left">ä¸‹ä¸€ä¸ª undo log çš„ä½ç½®</td>
</tr>
<tr>
<td align="left">type_cmpl (1)</td>
<td align="left">Undo ç±»å‹ï¼ŒTRX_UNDO_INSERT_REC: 11</td>
</tr>
<tr>
<td align="left">Undo Number</td>
<td align="left">åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä» 0 å¼€å§‹é€’å¢</td>
</tr>
<tr>
<td align="left">Table ID</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Key Field 1 Length</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Key Field 1 Content</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">â€¦</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Key Field n Length</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Key Field n Content</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">undo å¼€å§‹çš„ä½ç½®</td>
</tr>
</tbody></table>
<blockquote>
<p>INSERT æ“ä½œçš„ undo log record åœ¨äº‹åŠ¡æäº¤åå°±å¯ä»¥åˆ é™¤</p>
</blockquote>
<h4 id="8-2-Update-Undo-Log-Record"><a href="#8-2-Update-Undo-Log-Record" class="headerlink" title="8.2. Update Undo Log Record"></a>8.2. Update Undo Log Record</h4><p>è¯¥ç±»åˆ«çš„ Undo Log Record å¯ä»¥å†åˆ†ä¸ºä¸‰ç§ï¼š</p>
<ul>
<li>TRX_UNDO_DEL_MARK_REC</li>
<li>TRX_UNDO_UPD_DEL_REC</li>
<li>TRX_UNDO_UPD_EXIST_REC</li>
</ul>
<p>TRX_UNDO_UPD_EXIST_REC</p>
<table>
<thead>
<tr>
<th align="left"><div style="width: 200px">å­—æ®µ</div></th>
<th align="left">å ç”¨</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">end of record</td>
<td align="left">2</td>
<td align="left">æœ¬é¡µä¸­ï¼Œè¯¥è®°å½•çš„æœ«å°¾åç§»é‡ã€‚åªæœ‰å½“è®°å½•å®Œå…¨å†™å®Œæ‰èƒ½å†™å…¥ï¼Œäº‹å…ˆä¸çŸ¥é“å¤§å°ã€‚</td>
</tr>
<tr>
<td align="left">type_cmpl</td>
<td align="left">1</td>
<td align="left">TRX_UNDO_UPD_EXIST_REC</td>
</tr>
<tr>
<td align="left">undo_no</td>
<td align="left"></td>
<td align="left">åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä» 0 å¼€å§‹é€’å¢</td>
</tr>
<tr>
<td align="left">table id</td>
<td align="left"></td>
<td align="left">è¡¨ ID</td>
</tr>
<tr>
<td align="left">info bits</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">trx_id</td>
<td align="left">å‹ç¼©</td>
<td align="left">æ—§è®°å½•çš„ trx_id</td>
</tr>
<tr>
<td align="left">roll_pointer</td>
<td align="left">å‹ç¼©</td>
<td align="left">æ—§è®°å½•çš„ roll_pointer</td>
</tr>
<tr>
<td align="left">clustered index 1 length</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• 1 é•¿åº¦</td>
</tr>
<tr>
<td align="left">clustered index 1 value</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• 1 å€¼</td>
</tr>
<tr>
<td align="left">â€¦</td>
<td align="left">â€¦</td>
<td align="left">â€¦</td>
</tr>
<tr>
<td align="left">clustered index n length</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• n é•¿åº¦</td>
</tr>
<tr>
<td align="left">clustered index n value</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• n å€¼</td>
</tr>
<tr>
<td align="left">n_updated</td>
<td align="left"></td>
<td align="left">å…±æœ‰å¤šå°‘ä¸ªåˆ—è¢«æ›´æ–°äº†</td>
</tr>
<tr>
<td align="left">len of index_col_info</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">start of record</td>
<td align="left">2</td>
<td align="left">æœ¬é¡µä¸­ï¼Œè¯¥è®°å½•çš„èµ·å§‹åç§»é‡</td>
</tr>
</tbody></table>
<p>TRX_UNDO_DEL_MARK_REC</p>
<table>
<thead>
<tr>
<th align="left"><div style="width: 200px">å­—æ®µ</div></th>
<th align="left">å ç”¨</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">end of record (2)</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Type and Flags (1)</td>
<td align="left"></td>
<td align="left">TRX_UNDO_DEL_MARK_REC</td>
</tr>
<tr>
<td align="left">Undo Number</td>
<td align="left"></td>
<td align="left">åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä» 0 å¼€å§‹é€’å¢</td>
</tr>
<tr>
<td align="left">Table ID</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Info Bits</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">trx_id</td>
<td align="left"></td>
<td align="left">æ—§è®°å½•çš„ trx_id</td>
</tr>
<tr>
<td align="left">roll_pointer</td>
<td align="left"></td>
<td align="left">æ—§è®°å½•çš„ roll_pointer</td>
</tr>
<tr>
<td align="left">clustered index 1 length</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• 1 é•¿åº¦</td>
</tr>
<tr>
<td align="left">clustered index 1 value</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• 1 å€¼</td>
</tr>
<tr>
<td align="left">â€¦</td>
<td align="left">â€¦</td>
<td align="left">â€¦</td>
</tr>
<tr>
<td align="left">clustered index n length</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• n é•¿åº¦</td>
</tr>
<tr>
<td align="left">clustered index n value</td>
<td align="left"></td>
<td align="left">èšç°‡ç´¢å¼• n å€¼</td>
</tr>
<tr>
<td align="left">start of record</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">äº‹åŠ¡ä¸­ DELETE ä»…å°†è®°å½•çš„ deleted_flag æ ‡è¯†è®¾ç½®ä¸º 1</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">å½“å¯¹æ¯ä¸€æ¡æ•°æ®è®°å½•è¿›è¡Œ delete mark æ“ä½œå‰ï¼Œéœ€è¦æŠŠè¯¥æ•°æ®è®°å½•çš„ trx_id å’Œ roll_pointer çš„æ—§å€¼è®°å½•åˆ° undo log recordï¼Œå†å°† trx_id å’Œ roll_pointer æ›´æ–°ã€‚</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>æ’¤é”€æ—¥å¿—æ˜¯ä¸ºäº†å®ç°äº‹åŠ¡åŸå­æ€§è€Œå‡ºç°çš„äº§ç‰©ã€‚äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯æˆ–è€…ç”¨æˆ·æ‰§è¡Œäº† rollback è¯­å¥ï¼ŒMySQL å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„ä¿¡æ¯å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€<br>æ’¤é”€æ—¥å¿—åœ¨ MySQL InnoDB å­˜å‚¨å¼•æ“ä¸­è¿˜ç”¨æ¥å®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚</p>
</blockquote>
<p>åœ¨å…¨å±€ä¸´æ—¶è¡¨ç©ºé—´ä¸­çš„ Undo Log ç”¨äºäº‹åŠ¡ä¿®æ”¹ç”¨æˆ·å®šä¹‰çš„ä¸´æ—¶è¡¨ä¸­çš„æ•°æ®ã€‚è¿™äº› Undo Log ä¸ä¼šè®°å½• Redo Logï¼Œå› ä¸ºå´©æºƒæ¢å¤ä¸éœ€è¦å®ƒä»¬ã€‚å®ƒä»¬ä»…åœ¨æœåŠ¡å™¨è¿è¡Œæ—¶ç”¨äºå›æ»šã€‚è¿™ç§ç±»å‹çš„ Undo Log é€šè¿‡é¿å… Redo æ—¥å¿— I&#x2F;O å¯¹æ€§èƒ½æœ‰å¸®åŠ©ã€‚<br>æ¯ä¸ª undo è¡¨ç©ºé—´å’Œå…¨å±€ä¸´æ—¶è¡¨ç©ºé—´æœ€å¤šæ”¯æŒ 128 ä¸ªå›æ»šæ®µã€‚<code>innodb_rollback_segments</code> å˜é‡å®šä¹‰äº†å›æ»šæ®µçš„æ•°é‡ã€‚<br>äº‹åŠ¡æœ€å¤šåˆ†é… 4 ä¸ª undo æ—¥å¿—ï¼Œæ¯ä¸ªå¯¹åº”ä¸‹é¢çš„æ“ä½œç±»å‹ï¼š</p>
<ol>
<li><code>INSERT</code> ç”¨æˆ·å®šä¹‰çš„è¡¨</li>
<li><code>UPDATE</code> å’Œ <code>DELETE</code> ç”¨æˆ·å®šä¹‰çš„è¡¨</li>
<li><code>INSERT</code> ç”¨æˆ·å®šä¹‰çš„ä¸´æ—¶è¡¨</li>
<li><code>UPDATE</code> å’Œ <code>DELETE</code> ç”¨æˆ·å®šä¹‰çš„ä¸´æ—¶è¡¨<br>æ ¹æ®éœ€è¦åˆ†é… undo æ—¥å¿—ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå¸¸è§„è¡¨å’Œä¸´æ—¶è¡¨ä¸Šçš„ <code>INSERT</code>ï¼Œ<code>UPDATE</code>ï¼Œä»¥åŠ <code>DELETE</code> æ“ä½œçš„äº‹åŠ¡éœ€è¦å®Œå…¨åˆ†é… 4 ä¸ª undo æ—¥å¿—ï¼›ä»…åœ¨å¸¸è§„è¡¨ä¸Šæ‰§è¡Œ <code>INSERT</code> æ“ä½œçš„äº‹åŠ¡åªéœ€è¦ 1 ä¸ª undo æ—¥å¿—ã€‚</li>
</ol>
<ul>
<li>å¦‚æœæ¯ä¸ªäº‹åŠ¡æ‰§è¡Œ <code>INSERT</code> æˆ–è€… <code>UPDATE</code> æˆ–è€… <code>DELETE</code> æ“ä½œä¹‹ä¸€ï¼Œé‚£ä¹ˆ InnoDB å¯ä»¥æ”¯æŒçš„å¹¶å‘ç‹¬å†™äº‹åŠ¡æ•°æ˜¯ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(innodb_page_size / 16) * innodb_rollback_segments * number of undo tablespaces</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æœæ¯ä¸ªäº‹åŠ¡æ‰§è¡Œ <code>INSERT</code> åŠ ä¸Š <code>UPDATE</code> æˆ–è€… <code>DELETE</code> æ“ä½œä¹‹ä¸€ï¼Œé‚£ä¹ˆ InnoDB å¯ä»¥æ”¯æŒçš„å¹¶å‘ç‹¬å†™äº‹åŠ¡æ•°æ˜¯ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(innodb_page_size / 16 / 2) * innodb_rollback_segments * number of undo tablespaces</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æœæ¯ä¸ªäº‹åŠ¡éƒ½åœ¨ä¸´æ—¶è¡¨ä¸Šæ‰§è¡Œ <code>INSERT</code> æ“ä½œï¼Œé‚£ä¹ˆ InnoDB å¯ä»¥æ”¯æŒçš„å¹¶å‘ç‹¬å†™äº‹åŠ¡æ•°æ˜¯ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(innodb_page_size / 16) * innodb_rollback_segments</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Undo-Log-åˆ†é…"><a href="#Undo-Log-åˆ†é…" class="headerlink" title="Undo Log åˆ†é…"></a>Undo Log åˆ†é…</h3><p>å½“å¼€å¯ä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>trx_assign_rseg_durable</code> åˆ†é…ä¸€ä¸ª Rollback Segmentã€‚<br>åªè¯»äº‹åŠ¡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trx_assign_rseg_temp();</span><br><span class="line">-&gt; get_next_temp_rseg();</span><br><span class="line">-&gt; trx_sys-&gt;tmp_rsegs</span><br></pre></td></tr></table></figure>
<p>è¯»å†™äº‹åŠ¡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">trx_assign_rseg_durable() </span><br><span class="line">-&gt; get_next_redo_rseg()</span><br><span class="line">    -&gt;get_next_redo_rseg_from_trx_sys() -&gt; (trx_sys-&gt;rsegs)</span><br><span class="line">      get_next_redo_rseg_from_undo_spaces() -&gt; (undo_space-&gt;rsegs())</span><br></pre></td></tr></table></figure>
<p>å½“ InnoDB æ²¡æœ‰é…ç½®ç‹¬ç«‹ Undo Tablespace æ—¶ï¼Œ trx_sys-&gt;regs ä¸ºè¯»å†™äº‹åŠ¡åˆ†é…å›æ»šæ®µï¼›å¦åˆ™ä» undo_spaces-&gt;regs() åˆ†é…å›æ»šæ®µ<br>å½“ç¬¬ä¸€æ¬¡çœŸæ­£äº§ç”Ÿä¿®æ”¹éœ€è¦å†™ Undo Log Record çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>trx_undo_assign_undo</code> æ¥è·å¾—ä¸€ä¸ª Undo Segment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">trx_undo_assign_undo(*trx. *undo_ptr, type) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å°è¯•è·å–ç¼“å­˜ä¸­å¯ç”¨çš„ Undo Log</span></span><br><span class="line"><span class="comment">     1. å¯¹äº type == TRX_UNDO_INSERT</span></span><br><span class="line"><span class="comment">          ä» rseg-&gt;insert_undo_cached é“¾è¡¨ä¸Šè·å– Undo Log å¯¹è±¡ï¼Œå¹¶ä»é“¾è¡¨ç§»é™¤</span></span><br><span class="line"><span class="comment">          ä¹‹åè°ƒç”¨ trx_undo_insert_header_reuse é‡æ–°åˆå§‹åŒ– Undo Page Header</span></span><br><span class="line"><span class="comment">     2. å¯¹äº type == TRX_UNDO_UPDATE</span></span><br><span class="line"><span class="comment">          ä» rseg-&gt;update_undo_cached é“¾è¡¨ä¸Šè·å– Undo Log å¯¹è±¡ï¼Œå¹¶ä»é“¾è¡¨ç§»é™¤</span></span><br><span class="line"><span class="comment">          ä¹‹åè°ƒç”¨ trx_undo_header_create åˆ›å»ºæ–°çš„ Undo Log Header</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">          </span><br><span class="line">    undo = trx_undo_reuse_cached();</span><br><span class="line">    <span class="keyword">if</span> (undo == nullptr) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰ç¼“å­˜çš„ Undo Log å¯¹è±¡ï¼Œè°ƒç”¨ trx_undo_create ä»å›æ»šæ®µä¸Šåˆ†é…ä¸€ä¸ªç©ºé—²çš„ Undo Slot</span></span><br><span class="line">        trx_undo_create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Undo-Log-å†™å…¥"><a href="#Undo-Log-å†™å…¥" class="headerlink" title="Undo Log å†™å…¥"></a>Undo Log å†™å…¥</h3><h4 id="1-åˆ†é…å›æ»šæ®µ"><a href="#1-åˆ†é…å›æ»šæ®µ" class="headerlink" title="1. åˆ†é…å›æ»šæ®µ"></a>1. åˆ†é…å›æ»šæ®µ</h4><p>äº‹åŠ¡ä»è°ƒç”¨ <code>trx_start_low</code> å‡½æ•°å¼€å§‹ã€‚</p>
<p>å½“è¯¥äº‹åŠ¡è¢«åˆ¤å®šä¸ºè¯»å†™æ¨¡å¼æ—¶ï¼Œä¼šåˆ†é… TRX_ID ä»¥åŠå›æ»šæ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¥è‡ª trx_start_low ç‰‡æ®µ</span></span><br><span class="line"><span class="keyword">if</span> (!trx-&gt;read_only &amp;&amp;</span><br><span class="line">      (trx-&gt;mysql_thd == nullptr || read_write || trx-&gt;ddl_operation)) &#123;</span><br><span class="line">    <span class="comment">// åˆ†é… Rollback Segment</span></span><br><span class="line">    trx_assign_rseg_durable(trx);</span><br><span class="line">    <span class="comment">// åˆ†é… TRX_ID</span></span><br><span class="line">    trx-&gt;id = trx_sys_allocate_trx_id();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å½“å†™äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ <code>trx_assign_rseg_durable</code>  åˆ†é…ä¸€ä¸ª Rollback Segmentã€‚</p>
<p>åˆ†é…ç­–ç•¥ï¼šä¾æ¬¡å°è¯•ä¸‹ä¸€ä¸ªæ´»è·ƒçš„ Rollback Segmentã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ Assign a durable rollback segment to a transaction in a round-robin</span><br><span class="line">fashion.</span><br><span class="line">@param[in,out]	trx	transaction that involves a durable write. */</span><br><span class="line"><span class="type">void</span> <span class="title function_">trx_assign_rseg_durable</span><span class="params">(<span class="type">trx_t</span> *trx)</span> &#123;</span><br><span class="line">  ut_ad(trx-&gt;rsegs.m_redo.rseg == nullptr);</span><br><span class="line"></span><br><span class="line">  trx-&gt;rsegs.m_redo.rseg = srv_read_only_mode ? nullptr : get_next_redo_rseg();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-ä½¿ç”¨å›æ»šæ®µ"><a href="#2-ä½¿ç”¨å›æ»šæ®µ" class="headerlink" title="2. ä½¿ç”¨å›æ»šæ®µ"></a>2. ä½¿ç”¨å›æ»šæ®µ</h4><p>å½“ç¬¬ä¸€æ¬¡çœŸæ­£äº§ç”Ÿä¿®æ”¹éœ€è¦å†™ Undo Record çš„æ—¶å€™ï¼Œä¼šä» <code>trx_undo_report_row_operation</code> è¿›å…¥ï¼Œæ¥ç€è°ƒç”¨ <code>trx_undo_assign_undo</code> è·å¾—ä¸€ä¸ª Undo Segmentã€‚ä¼˜å…ˆå¤ç”¨ <code>trx_rseg_t</code> ä¸Š Cached List ä¸­çš„ trx_undo_tï¼Œä¹Ÿå°±æ˜¯å·²ç»åˆ†é…å‡ºæ¥ä½†æ²¡æœ‰è¢«æ­£åœ¨ä½¿ç”¨çš„ Undo Segmentã€‚</p>
<p>å¦‚æœæ²¡æœ‰ç¼“å­˜çš„ Undo Segmentï¼Œæ‰è°ƒç”¨ <code>trx_undo_create</code> åˆ›å»ºæ–°çš„ Undo Segmentï¼Œ<code>trx_undo_create</code> ä¼šè½®è¯¢é€‰æ‹©å½“å‰ Rollback Segment ä¸­å¯ç”¨çš„ Slotï¼Œç”³è¯·æ–°çš„ Undo Pageï¼Œåˆå§‹åŒ– Undo Page Headerï¼ŒUndo Segment Header</p>
<h4 id="3-å†™å…¥"><a href="#3-å†™å…¥" class="headerlink" title="3. å†™å…¥"></a>3. å†™å…¥</h4><p>å¯¹äº INSERT UNDO LOG å†™å…¥çš„å…¥å£å‡½æ•° <code>trx_undo_page_report_insert</code></p>
<p>å¯¹äº UPDATE UNDO LOG å†™å…¥çš„å…¥å£å‡½æ•° <code>trx_undo_page_report_modify</code></p>
<p>åœ¨å†™å…¥è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç° Undo Page ç©ºé—´ä¸è¶³çš„æƒ…å†µï¼Œå½“å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šè°ƒç”¨ <code>trx_undo_erase_page_end</code> æ¥æ¸…é™¤åˆšåˆšå†™å…¥çš„åŒºåŸŸï¼Œç„¶åè°ƒç”¨ <code>trx_undo_add_page</code> ç”³è¯·ä¸€ä¸ªæ–°çš„ Undo Page åŠ å…¥åˆ° Undo Page Listï¼ŒåŒæ—¶ undo-&gt;last_page_no æŒ‡å‘æ–°çš„ Undo Pageï¼Œé‡æ–°å°è¯•å†™å…¥ã€‚</p>
<h1 id="è¡¨ç©ºé—´"><a href="#è¡¨ç©ºé—´" class="headerlink" title="è¡¨ç©ºé—´"></a>è¡¨ç©ºé—´</h1><h2 id="ç³»ç»Ÿè¡¨ç©ºé—´"><a href="#ç³»ç»Ÿè¡¨ç©ºé—´" class="headerlink" title="ç³»ç»Ÿè¡¨ç©ºé—´"></a>ç³»ç»Ÿè¡¨ç©ºé—´</h2><p>The System Tablespace</p>
<p>ç³»ç»Ÿè¡¨ç©ºé—´æ˜¯æ›´æ”¹ç¼“å†²åŒºçš„å­˜å‚¨åŒºåŸŸã€‚å¦‚æœåœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­åˆ›å»ºè¡¨ï¼Œè€Œä¸æ˜¯æ¯å¼ è¡¨ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å¸¸è§„è¡¨ç©ºé—´ï¼Œå®ƒä¹Ÿå¯èƒ½åŒ…å«è¡¨å’Œç´¢å¼•æ•°æ®ã€‚åœ¨è¿‡äºçš„ç‰ˆæœ¬ä¸­ï¼Œç³»ç»Ÿè¡¨ç©ºé—´åŒ…å« InnoDB çš„æ•°æ®å­—å…¸ã€‚åœ¨ MySQL 8.0 ä¸­ï¼ŒInnoDB å°†å…ƒæ•°æ®å­˜å‚¨åœ¨æ•°æ®å­—å…¸ä¸­ã€‚<br>ç³»ç»Ÿè¡¨ç©ºé—´å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ•°æ®æ–‡ä»¶ã€‚é»˜è®¤åœ°ï¼Œä¼šåœ¨æ•°æ®æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªç³»ç»Ÿè¡¨ç©ºé—´æ•°æ®æ–‡ä»¶ï¼Œåä¸º <code>ibdata</code>ã€‚ç³»ç»Ÿè¡¨ç©ºé—´çš„å¤§å°å’Œæ•°é‡ç”± innodb_data_file_path å¯åŠ¨é¡¹å®šä¹‰ã€‚</p>
<h2 id="File-Per-Table-Tablespaces"><a href="#File-Per-Table-Tablespaces" class="headerlink" title="File-Per-Table Tablespaces"></a>File-Per-Table Tablespaces</h2><p>å¯¹äºå•ä¸ª InnoDB è¡¨ï¼Œfile-per-table è¡¨ç©ºé—´åŒ…å«äº†è¯¥è¡¨çš„æ•°æ®ä»¥åŠç´¢å¼•ï¼Œå¹¶å­˜å‚¨äºæ–‡ä»¶ç³»ç»Ÿçš„å•ä¸ªæ–‡ä»¶ä¸­</p>
<h1 id="Redo-Log-é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§"><a href="#Redo-Log-é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§" class="headerlink" title="Redo Log é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§"></a>Redo Log é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§</h1><p>Redo Log æ˜¯åœ¨å´©æºƒæœŸé—´ä½¿ç”¨çš„åŸºäºç£ç›˜çš„æ•°æ®ç»“æ„ï¼Œä»¥çº æ­£ä¸å®Œæ•´äº‹åŠ¡å†™å…¥çš„æ•°æ®ã€‚<br>åœ¨æ­£å¸¸æ“ä½œæœŸé—´ï¼ŒRedo Log å°†é‚£äº›æ¥è‡ªäº SQL è¯­å¥æˆ–è€…ä½çº§ API è°ƒç”¨çš„è¡¨æ•°æ®ä¿®æ”¹æ“ä½œè¯·æ±‚è¿›è¡Œç¼–ç ã€‚<br>åœ¨åˆå§‹åŒ–å¹¶æ¥å—è¿æ¥ä¹‹å‰ï¼Œé‚£äº›ç”±äºæ— æ³•é¢„æœŸçš„å…³é—­å¯¼è‡´æœªèƒ½å°†æ•°æ®æ–‡ä»¶æ›´æ–°çš„ä¿®æ”¹æ“ä½œä¼šè¢«é‡æ–°æ‰§è¡Œã€‚</p>
<blockquote>
<p>é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§<br>é»˜è®¤åœ°ï¼ŒRedo Log åœ¨ç‰©ç†ä¸Šè¡¨ç°ä¸ºç£ç›˜ä¸Šä¸¤ä¸ªåä¸º <code>ib_logfile0</code> å’Œ <code>ib_logfile1</code> çš„æ–‡ä»¶ã€‚MySQL ä»¥å¾ªç¯çš„æ–¹å¼å†™å…¥ Redo Log æ–‡ä»¶ã€‚æ ¹æ®å—å½±å“çš„è®°å½•ï¼ŒRedo Log å°†å®ƒä»¬ç¼–ç ï¼›è¿™äº›æ•°æ®ç»Ÿç§°ä¸º redoã€‚</p>
</blockquote>
<h2 id="Changing-the-Number-or-Size-of-Redo-Log-Files"><a href="#Changing-the-Number-or-Size-of-Redo-Log-Files" class="headerlink" title="Changing the Number or Size of Redo Log Files"></a>Changing the Number or Size of Redo Log Files</h2><p>å¦‚æœè¦ä¿®æ”¹ Redo Log çš„å¤§å°æ•°é‡ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>åœæ­¢ MySQL Server å¹¶ç¡®ä¿å®ƒæ²¡æœ‰é”™è¯¯å…³é—­</li>
<li>ç¼–è¾‘ my.cnf æ›´æ”¹æ—¥å¿—æ–‡ä»¶é…ç½®ã€‚è¦æ›´æ”¹æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé…ç½® <code>innodb_log_file_size</code>ã€‚ä¸ºäº†å¢åŠ æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼Œéœ€é…ç½® <code>innodb_log_files_in_group</code></li>
<li>å†æ¬¡å¯åŠ¨ MySQL æœåŠ¡<h2 id="Group-Commit-for-Redo-Log-Flushing"><a href="#Group-Commit-for-Redo-Log-Flushing" class="headerlink" title="Group Commit for Redo Log Flushing"></a>Group Commit for Redo Log Flushing</h2>ä¸å…¶ä»–ç¬¦åˆ ACID æ•°æ®åº“å¼•æ“ä¸€æ ·ï¼ŒInnoDB åœ¨æäº¤äº‹åŠ¡ä¹‹å‰ä¼šåˆ·å†™ï¼ˆflushï¼‰ Redo Logã€‚InnoDB ä½¿ç”¨ç»„æäº¤åŠŸèƒ½ï¼Œå°†å¤šä¸ª flush è¯·æ±‚ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥é¿å…ä¸ºæ¯ä¸ªæäº¤è¿›è¡Œä¸€æ¬¡ flush æ“ä½œã€‚ä½¿ç”¨ç»„æäº¤ï¼ŒInnoDB å‘æ—¥å¿—æ–‡ä»¶å‘å‡ºå•ä¸ªçš„å†™å…¥ï¼Œç”¨äºä¸ºåŒä¸€æ—¶é—´çš„å¤šä¸ªç”¨æˆ·äº‹åŠ¡æ‰§è¡Œæäº¤åŠ¨ä½œï¼Œè¿™å¯ä»¥æ˜¾è‘—æé«˜ååé‡ã€‚<h2 id="Redo-Log-Archiving"><a href="#Redo-Log-Archiving" class="headerlink" title="Redo Log Archiving"></a>Redo Log Archiving</h2>å¤åˆ¶ Redo Log è®°å½•çš„å¤‡ä»½å·¥å…·æœ‰æ—¶å€™å¯èƒ½ä¼šåœ¨è¿›è¡Œå¤‡ä»½æ“ä½œæ—¶æ— æ³•è·Ÿä¸Š Redo Log çš„ç”Ÿæˆé€Ÿåº¦ï¼Œå¯¼è‡´ç”±äºè¿™äº›è®°å½•è¢«è¦†ç›–è€Œå¯¼è‡´ Redo Log è®°å½•ä¸¢å¤±ã€‚åœ¨å¤‡ä»½æ“ä½œæœŸé—´ï¼Œå­˜åœ¨ç€æ˜¾è‘—çš„ MySQL æœåŠ¡æ´»åŠ¨ï¼Œå¹¶ä¸” Redo Log æ–‡ä»¶å­˜å‚¨ä»‹è´¨æ¯”å¤‡ä»½å­˜å‚¨ä»‹è´¨æ›´å¿«çš„é€Ÿåº¦è¿è¡Œæ—¶ï¼Œæœ€å¸¸å¸¸å‘ç”Ÿæ­¤é—®é¢˜ã€‚åœ¨ MySQL 8.0.17 ä¸­å¼•å…¥çš„é‡åšè®°å½•å½’æ¡£åŠŸèƒ½ï¼Œé€šè¿‡åœ¨ Redo Log æ–‡ä»¶ä¹‹å¤–å°† Redo Log è®°å½•é¡ºåºå†™å…¥å½’æ¡£æ–‡ä»¶æ¥è§£å†³æ­¤äº‹ã€‚<h2 id="Performance-Considerations"><a href="#Performance-Considerations" class="headerlink" title="Performance Considerations"></a>Performance Considerations</h2><img src="https://img-blog.csdnimg.cn/55d9b5977dcd478b9035dc0faee7a8fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA572Q6KOF6Z2i5YyF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></li>
</ol>
<h1 id="Undo-Tablespaces"><a href="#Undo-Tablespaces" class="headerlink" title="Undo Tablespaces"></a>Undo Tablespaces</h1><p>æ’¤é”€è¡¨ç©ºé—´åŒ…å« undo æ—¥å¿—ï¼Œè¿™äº›è®°å½•æ˜¯åŒ…å«æœ‰å…³å¦‚ä½•æ’¤é”€äº‹åŠ¡çš„æœ€æ–°çš„æ›´æ”¹çš„ä¿¡æ¯ã€‚<br>InnoDB æ˜¯ä¸€ä¸ªå¤šç‰ˆæœ¬çš„å­˜å‚¨å¼•æ“ã€‚å®ƒå¯ä»¥ä¿ç•™æœ‰å…³æ›´æ”¹è¡Œçš„æ—§ç‰ˆæœ¬çš„ä¿¡æ¯ï¼Œä»¥æ”¯æŒäº‹åŠ¡åŠŸèƒ½ï¼Œä¾‹å¦‚å¹¶å‘å’Œå›æ»šã€‚æ­¤ä¿¡æ¯ä»¥ä¸€ä¸ªç§°ä¸ºå›æ»šæ®µçš„æ•°æ®ç»“æ„ï¼Œå­˜å‚¨äº undo è¡¨ç©ºé—´ã€‚å›æ»šæ®µé©»ç•™åœ¨ undo è¡¨ç©ºé—´å’Œå…¨å±€ä¸´æ—¶è¡¨ç©ºé—´ä¸­ã€‚</p>
<h2 id="Default-Undo-Tablespaces"><a href="#Default-Undo-Tablespaces" class="headerlink" title="Default Undo Tablespaces"></a>Default Undo Tablespaces</h2><p>åˆå§‹åŒ– MySQL å®ä¾‹çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸¤ä¸ªé»˜è®¤çš„ undo è¡¨ç©ºé—´ã€‚<br>é»˜è®¤ undo è¡¨ç©ºé—´çš„åˆ›å»ºä½ç½®ç”± innodb_undo_directory å˜é‡å®šä¹‰ã€‚å¦‚æœ innodb_undo_directory å˜é‡æœªå®šä¹‰ï¼Œåˆ™å†æ•°æ®ç›®å½•ä¸­åˆ›å»ºé»˜è®¤çš„ undo è¡¨ç©ºé—´ã€‚é»˜è®¤ undo è¡¨ç©ºé—´æ•°æ®æ–‡ä»¶åä¸º <code>undo_001</code> å’Œ <code>undo_002</code>ã€‚æ•°æ®å­—å…¸ä¸­å®šä¹‰çš„ç›¸åº”çš„ undo è¡¨ç©ºé—´åç§°æ˜¯ innodb_undo_001 å’Œ innodb_undo_002</p>
<h2 id="Undo-Tablespace-Size"><a href="#Undo-Tablespace-Size" class="headerlink" title="Undo Tablespace Size"></a>Undo Tablespace Size</h2><p>åœ¨ MySQL 8.0.23 ä¹‹å‰ï¼Œundo è¡¨ç©ºé—´çš„å¤§å°å–å†³äº innodb_page_sizeã€‚å¯¹äºé»˜è®¤çš„ 16K é¡µå¤§å°ï¼Œåˆå§‹ undo è¡¨ç©ºé—´æ˜¯ 10MBã€‚</p>
<h2 id="Dropping-Undo-Tablespaces"><a href="#Dropping-Undo-Tablespaces" class="headerlink" title="Dropping Undo Tablespaces"></a>Dropping Undo Tablespaces</h2><p>MySQL 8.0.14 å¯ä»¥ä½¿ç”¨ <code>DROP UNDO TABLESPACES</code> è¯­æ³•åœ¨è¿è¡Œæ—¶åˆ é™¤ä½¿ç”¨ <code>CREATE UNDO TABLESPACES</code> è¯­æ³•åˆ›å»ºçš„è¡¨ç©ºé—´ã€‚</p>
<h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h2><p>ReadViewï¼Œæ¯ä¸ªäº‹åŠ¡åœ¨è¯»å–æ•°æ®çš„æ—¶å€™éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªè§†å›¾ï¼Œé€šè¿‡è§†å›¾å°±å¯ä»¥åˆ¤æ–­å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®çš„å¯è§æ€§ã€‚</p>
<p>åˆ†é…ï¼šé€šè¿‡ <code>trx_assign_read_view()</code> åˆ†é…è§†å›¾</p>
<p>å›æ”¶ï¼šäº‹åŠ¡ç»“æŸæ—¶ï¼Œä¼šé€šè¿‡ <code>view_close()</code> å¯¹å…¶è§†å›¾è¿›è¡Œå›æ”¶ã€‚</p>
<p><code>m_low_limit_id</code>ï¼šè¯»å–è¡Œä¸ºä¸åº”è¯¥çœ‹åˆ° <code>trx_id</code> &gt;&#x3D; <code>m_low_limit_id</code> çš„äº‹åŠ¡ï¼Œå³é«˜æ°´ä½ã€‚åˆ†é…æ—¶å– <code>trx_sys::max_trx_id</code>ï¼Œå³å½“å‰è¿˜æ²¡æœ‰è¢«åˆ†é…çš„äº‹åŠ¡æœ€å¤§ ID</p>
<p><code>m_up_limit_id</code>ï¼šè¯»å–è¡Œä¸ºåº”è¯¥å¯ä»¥çœ‹åˆ°æ‰€æœ‰ trx_id &lt; <code>m_up_limit_id</code> çš„äº‹åŠ¡ï¼Œå³ä½æ°´ä½ã€‚ä½æ°´ä½ï¼Œå¦‚æœm_idsä¸ä¸ºç©ºï¼Œå–å…¶æœ€å°å€¼ï¼Œå¦åˆ™å–trx_sys::max_trx_idï¼Œå³ä¸é«˜æ°´ä½ç›¸ç­‰ã€‚</p>
<blockquote>
<p>å…³äº <code>m_low_limit_id</code> å’Œ <code>m_up_limit_id</code> çš„è§£é‡Šä»¥åŠé«˜æ°´ä½å’Œä½æ°´ä½çš„æ¯”å–»å‡æ¥è‡ªäºæºç æ³¨é‡Šã€‚</p>
</blockquote>
<p><code>m_ids</code>ï¼šåœ¨æ­¤è§†å›¾åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡ <code>copy_trx_ids()</code> ä» <code>trx_sys::rw_trx_ids</code> æ‹·è´ä¸€ä»½æ´»è·ƒäº‹åŠ¡ID(ä¸åŒ…å«å½“å‰äº‹åŠ¡ID)ã€‚</p>
</section>
    <!-- Tags START -->
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2022/07/10/Spring-Framework/Spring-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/">
        <span class="nav-arrow">â† </span>
        
          Spring å¾ªç¯ä¾èµ–
        
      </a>
    
    
      <a class="nav-right" href="/2022/07/12/Nginx-%E5%AE%98%E6%96%B9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
        
          Nginx å®˜æ–¹å­¦ä¹ ç¬”è®°
        
        <span class="nav-arrow"> â†’</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- æ‰“èµ START -->
    
      <div class="money-like">
        <div class="reward-btn">
          èµ
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>ä½¿ç”¨æ”¯ä»˜å®æ‰“èµ</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>ä½¿ç”¨å¾®ä¿¡æ‰“èµ</b>
            </span>
          </span>
        </div>
        <p class="notice">è‹¥ä½ è§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯¹æˆ‘æ‰“èµ</p>
      </div>
    
    <!-- æ‰“èµ END -->
    <!-- äºŒç»´ç  START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">æ‰«æäºŒç»´ç ï¼Œåˆ†äº«æ­¤æ–‡ç« </p>
      </div>
    
    <!-- äºŒç»´ç  END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo="JiangChunbo/jiangchunbo.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-nav-text">å‚è€ƒæ–‡çŒ®</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Undo-Logs"><span class="toc-nav-text">Undo Logs</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-Undo-Tablespaces"><span class="toc-nav-text">1. Undo Tablespaces</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-Rollback-Segment"><span class="toc-nav-text">2. Rollback Segment</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#3-Rollback-Segment-Array-Header"><span class="toc-nav-text">3. Rollback Segment Array Header</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#4-Rollback-Segment-Header"><span class="toc-nav-text">4. Rollback Segment Header</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-Undo-Page"><span class="toc-nav-text">5. Undo Page</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-Undo-Page-Header"><span class="toc-nav-text">6. Undo Page Header</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-Undo-Segment"><span class="toc-nav-text">6. Undo Segment</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#7-Undo-Segment-Header"><span class="toc-nav-text">7. Undo Segment Header</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-Undo-Log-Header"><span class="toc-nav-text">8. Undo Log Header</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-Undo-Log-Record-%E7%BB%93%E6%9E%84"><span class="toc-nav-text">8. Undo Log Record ç»“æ„</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#8-1-Insert-Undo-Log-Record"><span class="toc-nav-text">8.1. Insert Undo Log Record</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#8-2-Update-Undo-Log-Record"><span class="toc-nav-text">8.2. Update Undo Log Record</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Undo-Log-%E5%88%86%E9%85%8D"><span class="toc-nav-text">Undo Log åˆ†é…</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Undo-Log-%E5%86%99%E5%85%A5"><span class="toc-nav-text">Undo Log å†™å…¥</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E5%88%86%E9%85%8D%E5%9B%9E%E6%BB%9A%E6%AE%B5"><span class="toc-nav-text">1. åˆ†é…å›æ»šæ®µ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E4%BD%BF%E7%94%A8%E5%9B%9E%E6%BB%9A%E6%AE%B5"><span class="toc-nav-text">2. ä½¿ç”¨å›æ»šæ®µ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#3-%E5%86%99%E5%85%A5"><span class="toc-nav-text">3. å†™å…¥</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="toc-nav-text">è¡¨ç©ºé—´</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="toc-nav-text">ç³»ç»Ÿè¡¨ç©ºé—´</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#File-Per-Table-Tablespaces"><span class="toc-nav-text">File-Per-Table Tablespaces</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Redo-Log-%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97%E7%94%A8%E6%9D%A5%E5%AE%9E%E7%8E%B0%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%8C%81%E4%B9%85%E6%80%A7"><span class="toc-nav-text">Redo Log é‡åšæ—¥å¿—ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Changing-the-Number-or-Size-of-Redo-Log-Files"><span class="toc-nav-text">Changing the Number or Size of Redo Log Files</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Group-Commit-for-Redo-Log-Flushing"><span class="toc-nav-text">Group Commit for Redo Log Flushing</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Redo-Log-Archiving"><span class="toc-nav-text">Redo Log Archiving</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Performance-Considerations"><span class="toc-nav-text">Performance Considerations</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Undo-Tablespaces"><span class="toc-nav-text">Undo Tablespaces</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Default-Undo-Tablespaces"><span class="toc-nav-text">Default Undo Tablespaces</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Undo-Tablespace-Size"><span class="toc-nav-text">Undo Tablespace Size</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Dropping-Undo-Tablespaces"><span class="toc-nav-text">Dropping Undo Tablespaces</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#MVCC"><span class="toc-nav-text">MVCC</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://example.com/2022/07/11/InnoDB æ—¥å¿—/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
    
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>